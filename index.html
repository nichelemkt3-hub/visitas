<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Valida√ß√£o de Visita</title>

  <!-- üîπ PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#1a73e8">

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    button {
      width: 100%;
      padding: 15px;
      font-size: 16px;
      margin-top: 10px;
    }
    img {
      max-width: 100%;
      margin-top: 10px;
    }
  </style>
</head>

<body>

<h2>Valida√ß√£o de Visita</h2>

<button onclick="capturarLocalizacao()">üìç Capturar Localiza√ß√£o</button>
<p id="localizacao"></p>

<button onclick="abrirCamera()">üì∏ Tirar Foto</button>
<input type="file" id="camera" accept="image/*" capture="environment" hidden>
<img id="preview">

<button onclick="enviar()">‚úÖ Confirmar Visita</button>
<p id="status"></p>

<script>
let latitude = null;
let longitude = null;
let fotoBase64 = null;

// üî¥ URL DO WEBAPP (OK)
const API_URL = "https://script.google.com/macros/s/AKfycbxiEIHlrt6tX2-o3N-oFvDn3aWtZ9ClGEUtInbsXJm6r6t-gRR2wrqj1TYOH8r4KhFJMg/exec";

function capturarLocalizacao() {
  navigator.geolocation.getCurrentPosition(
    pos => {
      latitude = pos.coords.latitude;
      longitude = pos.coords.longitude;
      document.getElementById("localizacao").innerText =
        `Latitude: ${latitude} | Longitude: ${longitude}`;
    },
    () => alert("Erro ao obter localiza√ß√£o")
  );
}

function abrirCamera() {
  document.getElementById("camera").click();
}

document.getElementById("camera").addEventListener("change", e => {
  const file = e.target.files[0];
  const reader = new FileReader();
  reader.onload = () => {
    fotoBase64 = reader.result;
    document.getElementById("preview").src = fotoBase64;
  };
  reader.readAsDataURL(file);
});

function enviar() {
  if (!latitude || !longitude || !fotoBase64) {
    alert("Falta localiza√ß√£o ou foto");
    return;
  }

  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({
      lat: latitude,
      lng: longitude,
      fotoBase64: fotoBase64
    })
  })
  .then(r => r.json())
  .then(res => {
    document.getElementById("status").innerText =
      res.codigo
        ? "Visita confirmada! C√≥digo: " + res.codigo
        : "Erro: " + res.erro;
  })
  .catch(() => {
    document.getElementById("status").innerText =
      "Erro ao enviar dados";
  });
}
</script>

</body>
</html>
